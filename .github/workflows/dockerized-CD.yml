name: Dockerized CD Pipeline
on:
  workflow_run:
    workflows: ["Dockerized CI Pipeline"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull Docker Image
        run: docker pull ghcr.io/${{ github.actor }}/react-app-cicd:${{ github.event.workflow_run.head_sha }}
      
      - name: Run Container
        run: |
          docker run -d -p 8080:80 --name react-app-test \
            ghcr.io/${{ github.actor }}/react-app-cicd:${{ github.event.workflow_run.head_sha }}
      
      - name: Wait for Container to Start
        run: sleep 5
      
      - name: Test Application
        run: |
          curl -f http://localhost:8080 || exit 1
          echo "Application is responding correctly"
      
      - name: Clean Up Container
        if: always()
        run: |
          docker stop react-app-test || true
          docker rm react-app-test || true